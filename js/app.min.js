import{resetSplide,formatHTMLForSplide,newSplide,splide}from"../js/splideFunctions.js";require(["esri/Map","esri/views/MapView","esri/layers/FeatureLayer","esri/layers/GraphicsLayer","esri/widgets/Sketch/SketchViewModel","esri/Graphic","esri/tasks/support/AttachmentQuery","esri/Basemap","esri/layers/VectorTileLayer","esri/widgets/Zoom/ZoomViewModel","esri/layers/support/LabelClass","esri/geometry/geometryEngine","esri/views/layers/support/FeatureEffect"],(function(Map,MapView,FeatureLayer,GraphicsLayer,SketchViewModel,Graphic,AttachmentQuery,Basemap,VectorTileLayer,ZoomViewModel,LabelClass,geometryEngine){var view,map,localitiesLayer,localityLayerView,countiesLayer,regionsLayer,neighborhoodsLayer,clientFeatureLayer,selectedFeatureGraphicLayer,sketchGraphicsLayer,sketchViewModel,zoomViewModel,highlight,polygonHighlight,splideHighlight,featureName,query,infoDiv=document.getElementById("infoDiv"),sliderDiv=document.getElementById("sliderDiv"),zoomDiv=document.getElementById("zoomDiv"),zoomInDiv=document.getElementById("zoom-in"),zoomOutDiv=document.getElementById("zoom-out"),featureCountDiv=document.getElementById("featureCount"),invertCountDiv=document.getElementById("invertCount"),vertCountDiv=document.getElementById("vertCount"),noFossilsInfo=document.getElementById("noFossilsInfo"),taxaInfo=document.getElementById("taxaInfo");setUpMap();var resetMapSetInterval=setInterval(resetButtonClickHandler,9e4);function setNavigationBounds(){var initialExtent=view.extent;view.watch("stationary",(function(event){if(event){var currentCenter=view.extent.center;if(!initialExtent.contains(currentCenter)){var newCenter=view.extent.center;currentCenter.x<initialExtent.xmin&&(newCenter.x=initialExtent.xmin),currentCenter.x>initialExtent.xmax&&(newCenter.x=initialExtent.xmax),currentCenter.y<initialExtent.ymin&&(newCenter.y=initialExtent.ymin),currentCenter.y>initialExtent.ymax&&(newCenter.y=initialExtent.ymax),view.goTo(newCenter)}}}))}function resetButtonClickHandler(){sketchViewModel.cancel(),view.goTo({center:[-118.248638,34.06266],zoom:8}),highlight&&highlight.remove(),resetClientFeatureLayer(),clearGraphics(),clearWidgets()}function polygonButtonClickHandler(){featureName="",clearGraphics(),sketchViewModel.create("polygon",{mode:"freehand"})}function zoomInClickHandler(){zoomViewModel.zoomIn()}function zoomOutClickHandler(){zoomViewModel.zoomOut()}function hideDiv(div){div.style.marginLeft="-1000px"}function displayDiv(div){div.style.display="block",div.style.marginLeft="0px"}function clearWidgets(){hideDiv(sliderDiv),hideDiv(infoDiv)}function resetInfoDiv(){featureCountDiv.innerHTML="",invertCountDiv.innerHTML="",vertCountDiv.innerHTML=""}function clearGraphics(){sketchGraphicsLayer.removeAll(),selectedFeatureGraphicLayer.removeAll(),view.graphics.removeAll()}function resetClientFeatureLayer(){clientFeatureLayer.queryFeatures().then((function(results){const removeFeatures={deleteFeatures:results.features};applyEditsToClientFeatureLayer(removeFeatures)}))}function addEdits(results){var graphics=[];results.features.forEach((function(feature){var graphic=new Graphic({geometry:feature.geometry,attributes:feature.attributes});graphics.push(graphic)}));const edits={addFeatures:graphics};applyEditsToClientFeatureLayer(edits)}function applyEditsToClientFeatureLayer(edits){clientFeatureLayer.applyEdits(edits).then((function(results){if(results.deleteFeatureResults.length>0&&console.log(results.deleteFeatureResults.length,"features have been removed"),results.addFeatureResults.length>0){var objectIds=[];results.addFeatureResults.forEach((function(feature){objectIds.push(feature.objectId)})),clientFeatureLayer.queryFeatures({objectIds:objectIds}).then((function(results){console.log(results.features.length,"features have been added.")}))}})).catch((function(error){console.log(error)}))}function selectFeaturesFromClick(screenPoint){clearGraphics();var includeLayers=[countiesLayer,neighborhoodsLayer,regionsLayer,clientFeatureLayer];view.hitTest(screenPoint,{include:includeLayers}).then((function(response){if(response.results.length>0){var clickFeature=response.results[0].graphic;featureName=clickFeature.attributes.name,selectFeatures(clickFeature),displayIntersectionFeatures(clickFeature);const selectedFeatureGraphic=new Graphic({geometry:clickFeature.geometry,symbol:{type:"simple-fill",color:[0,185,235,.2],outline:{color:[0,185,235,1],width:4}}});selectedFeatureGraphicLayer.graphics.removeAll(),selectedFeatureGraphicLayer.graphics.add(selectedFeatureGraphic)}else resetButtonClickHandler()}))}function selectFeatures(polygon){var geometry=geometryEngine.simplify(polygon.geometry,1e3);query.geometry=geometry,query.spatialRelationship="intersects",query.outFields=["*"],query.returnGeometry=!0,localitiesLayer.queryFeatures(query).then((function(results){var queriedLocalities=results.features,objectIds=queriedLocalities.map(loc=>loc.attributes.OBJECTID),invertCount=queriedLocalities.filter(loc=>"Invertebrate"==loc.attributes.category).length,vertCount=queriedLocalities.filter(loc=>"Vertebrate"==loc.attributes.category).length,taxa=queriedLocalities.map(loc=>loc.attributes.taxa).filter(taxa=>!(""==taxa)),geometryOffset=-geometry.extent.width/2;if("Los Angeles"===featureName?view.goTo({center:[-118.735491,34.222515],zoom:8}).catch((function(error){"AbortError"!=error.name&&console.error(error)})):"Ventura"==featureName?view.goTo({center:[-119.254898,34.515522],zoom:8}).catch((function(error){"AbortError"!=error.name&&console.error(error)})):view.goTo(geometry.extent.expand(2).offset(geometryOffset,0)).catch((function(error){"AbortError"!=error.name&&console.error(error)})),queriedLocalities.length>0){createSplideFromAttachments(localitiesLayer,objectIds),"block"===noFossilsInfo.style.display?(hideDiv(infoDiv),setTimeout(()=>{noFossilsInfo.style.display="none",displayDiv(taxaInfo),displayDiv(infoDiv)},500)):(displayDiv(taxaInfo),displayDiv(infoDiv));var fossilsFound=queriedLocalities.length;featureName?(document.getElementById("featureCount").innerHTML=fossilsFound.toString(),document.getElementById("featureText").innerHTML=1===fossilsFound?" fossil site in </br>"+featureName+"!":" fossil sites in </br>"+featureName+"!"):(document.getElementById("featureCount").innerHTML=fossilsFound.toString(),document.getElementById("featureText").innerHTML=1===fossilsFound?" fossil site in </br> in the area!":" fossil sites in </br> in the area!"),invertCountDiv.innerHTML=invertCount+" invertebrates",vertCountDiv.innerHTML=vertCount+" vertebrates"}else"block"===taxaInfo.style.display&&(hideDiv(infoDiv),setTimeout(()=>{taxaInfo.style.display="none",displayDiv(infoDiv),displayDiv(noFossilsInfo)},500)),hideDiv(sliderDiv);highlight&&highlight.remove(),highlight=localityLayerView.highlight(queriedLocalities)})).catch((function(error){console.log(error)}))}function displayIntersectionFeatures(feature){var regionType=feature.layer.title,query={where:"parent_region = '"+featureName+"'",returnGeometry:!0};clientFeatureLayer.queryFeatures().then((function(results){const removeFeatures={deleteFeatures:results.features};applyEditsToClientFeatureLayer(removeFeatures)})),"Counties"==regionType?regionsLayer.queryFeatures(query).then((function(results){addEdits(results)})):neighborhoodsLayer.queryFeatures(query).then((function(results){addEdits(results)}))}function createSplideFromAttachments(layer,ids){var attachmentList,attachmentQuery=new AttachmentQuery({objectIds:ids});layer.queryAttachments(attachmentQuery).then((function(attachments){if((attachmentList=Object.values(attachments).map(attachment=>attachment[0])).length>0){resetSplide(),attachmentList.forEach(attachment=>{formatHTMLForSplide(attachment)});var slidePagination=document.getElementById("slidePagination");slidePagination&&slidePagination.remove(),displayDiv(sliderDiv),newSplide(),createPointGraphicAtObjectId(attachmentList[0].parentObjectId),splide.on("active",(function(slide){const slideObjectId=slide.slide.classList[1];createPointGraphicAtObjectId(slideObjectId)}))}else hideDiv(sliderDiv)}))}function createPointGraphicAtObjectId(objectId){var highlightQuery={objectIds:[objectId],outFields:["*"]};localitiesLayer.queryFeatures(highlightQuery).then((function(attachment){var visibleAttachmentGeometry={type:"point",longitude:attachment.features[0].attributes.longitude,latitude:attachment.features[0].attributes.latitude};const selectedGraphic=new Graphic({geometry:visibleAttachmentGeometry,symbol:{type:"simple-marker",style:"circle",color:"orange",size:"12px",outline:{color:[255,255,0],width:2}}});view.graphics.removeAll(),view.graphics.add(selectedGraphic)}))}function setUpMap(){var basemap=new Basemap({baseLayers:[new VectorTileLayer({portalItem:{id:"c65f3f7dc5754366b4e515e73e2f7d8b"}})]});map=new Map({basemap:basemap}),view=new MapView({container:"viewDiv",map:map,center:[-118.248638,34.06266],zoom:8,constraints:{snapToZoom:!0,rotationEnabled:!1,minZoom:7},popup:{autoOpenEnabled:!1},highlightOptions:{color:[0,185,235,.75],fillOpacity:.4},ui:{components:[]}}),sketchGraphicsLayer=new GraphicsLayer,map.add(sketchGraphicsLayer),selectedFeatureGraphicLayer=new GraphicsLayer,map.add(selectedFeatureGraphicLayer),sketchViewModel=new SketchViewModel({view:view,layer:sketchGraphicsLayer,updateOnGraphicClick:!1,polygonSymbol:{type:"simple-fill",color:[0,185,235,.2],size:"1px",outline:{color:[0,185,235,.5],width:"3px"}}}),zoomViewModel=new ZoomViewModel({view:view});var drawContainer=document.getElementById("select-by-polygon"),drawSvg=document.getElementById("brush-path");drawContainer.addEventListener("click",(function(event){event.preventDefault,drawSvg.classList.remove("draw-animation"),drawContainer.offsetWidth,drawSvg.classList.add("draw-animation")}),!1);var resetContainer=document.getElementById("return-to-extent"),resetSvg=document.getElementById("reset-widget");resetContainer.addEventListener("click",(function(event){event.preventDefault,resetSvg.classList.remove("reset-animation"),resetContainer.offsetWidth,resetSvg.classList.add("reset-animation")}),!1);const localitiesRenderer={type:"simple",symbol:{type:"simple-marker",size:6,color:[20,204,180,.5],outline:{width:.5,color:[247,247,247,.5]}}},polygonFeatureRenderer={type:"simple",symbol:{type:"simple-fill",style:"none",outline:{color:[128,128,128,.5],width:"1.5px"}}},countiesLabelClass=new LabelClass({labelExpressionInfo:{expression:"$feature.NAME"},symbol:{type:"text",color:"rgb(40, 40, 40)",haloSize:.5,haloColor:"white",font:{family:"Avenir Next LT Pro Regular",weight:"bold",size:13}}}),regionsLabelClass=new LabelClass({labelExpressionInfo:{expression:"$feature.NAME"},symbol:{type:"text",color:"rgb(40, 40, 40)",haloSize:.5,haloColor:"white",deconflictionStrategy:"static",font:{family:"Avenir Next LT Pro Regular",weight:"normal",size:9.5}}}),areasLabelClass=new LabelClass({labelExpressionInfo:{expression:"Replace(Trim($feature.name), ' ', TextFormatting.NewLine)"},symbol:{type:"text",color:"rgb(40, 40, 40)",haloSize:.5,haloColor:"white",deconflictionStrategy:"static",font:{family:"Avenir Next LT Pro Regular",weight:"bold",size:9.5}}});var countiesMaxScale=1155581,regionsMaxScale=288895,neighborhoodsMinScale=144448;clientFeatureLayer=new FeatureLayer({title:"Areas",spatialReference:{wkid:4326},fields:[{name:"objectId",alias:"ObjectId",type:"oid"},{name:"name",alias:"Name",type:"string"},{name:"type",alias:"Type",type:"string"},{name:"region_type",alias:"Region Type",type:"string"}],objectIdField:"objectId",geometryType:"polygon",source:[],renderer:polygonFeatureRenderer,labelingInfo:[areasLabelClass]}),localitiesLayer=new FeatureLayer({url:"https://services7.arcgis.com/zT20oMv4ojQGbhWr/arcgis/rest/services/LAU_Localities_View/FeatureServer",renderer:localitiesRenderer}),query=localitiesLayer.createQuery(),countiesLayer=new FeatureLayer({url:"https://services7.arcgis.com/zT20oMv4ojQGbhWr/arcgis/rest/services/SoCal_Counties_View/FeatureServer",maxScale:1155581,labelingInfo:[countiesLabelClass],renderer:polygonFeatureRenderer,title:"Counties"}),regionsLayer=new FeatureLayer({url:"https://services7.arcgis.com/zT20oMv4ojQGbhWr/arcgis/rest/services/SoCal_Regions_(v2)_View/FeatureServer",minScale:1155581,maxScale:288895,labelingInfo:[regionsLabelClass],renderer:polygonFeatureRenderer,title:"Regions"}),neighborhoodsLayer=new FeatureLayer({url:"https://services7.arcgis.com/zT20oMv4ojQGbhWr/arcgis/rest/services/SoCal_Neighborhoods_View/FeatureServer",minScale:144448,labelingInfo:[regionsLabelClass],renderer:polygonFeatureRenderer,title:"Neighborhoods"}),map.addMany([neighborhoodsLayer,regionsLayer,countiesLayer,clientFeatureLayer,localitiesLayer]),view.ui.add("select-by-polygon","top-right"),view.ui.add("return-to-extent","top-right"),view.ui.add(zoomDiv,"bottom-right"),view.ui.add("widgetContainer","top-left"),view.whenLayerView(localitiesLayer).then((function(layerView){localityLayerView=layerView}))}document.onclick=clearInterval(resetMapSetInterval),document.getElementById("select-by-polygon").addEventListener("click",polygonButtonClickHandler),document.getElementById("return-to-extent").addEventListener("click",resetButtonClickHandler),zoomInDiv.addEventListener("click",zoomInClickHandler),zoomOutDiv.addEventListener("click",zoomOutClickHandler),view.when((function(){setNavigationBounds()})),view.on("click",(function(event){selectFeaturesFromClick(event)})),sketchViewModel.on("create",(function(event){"complete"===event.state&&selectFeatures(event.graphic)}))}));